<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>V-SLAM Debug Mode</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: monospace; color: white; }
        
        #console-log {
            position: absolute; top: 0; left: 0; width: 100%; height: 250px;
            background: rgba(0,0,0,0.8); pointer-events: none; z-index: 999;
            padding: 10px; box-sizing: border-box; font-size: 12px; color: #00ff00;
            overflow-y: auto; white-space: pre-wrap; border-bottom: 2px solid #555;
        }

        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 800;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        #btn-start {
            padding: 20px 40px; font-size: 20px; font-weight: bold; 
            background: #0088ff; color: white; border: none; border-radius: 10px; cursor: pointer;
            display: none; margin-top: 20px;
        }

        /* ë¹„ë””ì˜¤ ìˆ¨ê¹€ (íˆ¬ëª…) */
        #videoInput { position: absolute; top:0; left:0; opacity: 0; z-index: -1; }
        /* ìº”ë²„ìŠ¤ (í™”ë©´) */
        #canvasOutput { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; background: #111; z-index: 100;}

        #ui-controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 900; display: none;
        }
        #btn-visualize {
            padding: 15px 30px; font-size: 16px; font-weight: bold; 
            background: #ff4757; color: white; border: none; border-radius: 30px; 
        }
        #threejs-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 600; }
    </style>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>
    <div id="console-log">ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘...<br></div>

    <div id="start-overlay">
        <h2>V-SLAM Debug</h2>
        <div id="status-text">ì—”ì§„ ë‹¤ìš´ë¡œë“œ ì¤‘...</div>
        <button id="btn-start">ğŸ“· ì¹´ë©”ë¼ ì‹œì‘</button>
    </div>

    <video id="videoInput" playsinline webkit-playsinline></video>
    <canvas id="canvasOutput"></canvas>

    <div id="ui-controls"><button id="btn-visualize">â¹ 3D ë³€í™˜</button></div>
    <div id="threejs-container"></div>

    <script>
        function log(msg) {
            const el = document.getElementById('console-log');
            const time = new Date().toLocaleTimeString().split(' ')[0]; // ì‹œê°„ë§Œ í‘œì‹œ
            el.innerHTML += `[${time}] ${msg}<br>`;
            el.scrollTop = el.scrollHeight;
        }

        // 1. OpenCV ë¡œë“œ
        window.onOpenCvReady = function() {
            log("âœ… ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨.");
            checkOpenCv();
        };

        function checkOpenCv() {
            let attempts = 0;
            const timer = setInterval(() => {
                attempts++;
                if (typeof cv !== 'undefined' && cv.getBuildInformation) {
                    clearInterval(timer);
                    log("âœ… OpenCV ì´ˆê¸°í™” ì„±ê³µ!");
                    document.getElementById('status-text').innerText = "ì¤€ë¹„ ì™„ë£Œ";
                    
                    const btn = document.getElementById('btn-start');
                    btn.style.display = 'block';
                    btn.onclick = startCameraDebug;
                } else if (attempts > 50) {
                     log("...ì—”ì§„ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...");
                }
            }, 500);
        }
    </script>
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady()"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let video, canvas, ctx;
        let cap;
        let srcMat, grayMat, oldGrayMat, p0, p1, st, err;
        let isCVRunning = false;
        let finalFeatures = [];

        // 2. ì¹´ë©”ë¼ ì‹œì‘ (ë””ë²„ê·¸ ëª¨ë“œ)
        window.startCameraDebug = async function() {
            log("--- ì¹´ë©”ë¼ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ---");
            document.getElementById('start-overlay').style.display = 'none';
            
            video = document.getElementById('videoInput');
            canvas = document.getElementById('canvasOutput');
            ctx = canvas.getContext('2d', { willReadFrequently: true }); // ì„±ëŠ¥ ìµœì í™”

            try {
                // í•´ìƒë„ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­ (640x480) - ê°€ì¥ ì•ˆì •ì 
                const constraints = { 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }, 
                    audio: false 
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                log("1. ìŠ¤íŠ¸ë¦¼ íšë“í•¨.");
                video.srcObject = stream;
                
                // ë¹„ë””ì˜¤ ì¬ìƒ
                await video.play();
                log("2. ë¹„ë””ì˜¤ ì¬ìƒ ëª…ë ¹ ì „ì†¡.");
                
                // ë°”ë¡œ ì‹œì‘í•˜ì§€ ì•Šê³ , ë¹„ë””ì˜¤ê°€ ì§„ì§œ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê°ì‹œí•˜ëŠ” ë£¨í”„ ì‹¤í–‰
                monitorVideoState();

            } catch (err) {
                log("âŒ ì—ëŸ¬: " + err.name + " / " + err.message);
                alert("ì¹´ë©”ë¼ ì—ëŸ¬: " + err.name);
                document.getElementById('start-overlay').style.display = 'flex';
            }
        };

        // 3. ë¹„ë””ì˜¤ ìƒíƒœ ì •ë°€ ê°ì‹œ (Bad Size ì›ì²œ ì°¨ë‹¨)
        function monitorVideoState() {
            if (!video) return;

            const w = video.videoWidth;
            const h = video.videoHeight;
            const readyState = video.readyState; // 0:nothing, 4:enough_data

            if (w > 0 && h > 0 && readyState >= 3) { // 3 = HAVE_FUTURE_DATA
                log(`3. ë¹„ë””ì˜¤ ì¤€ë¹„ ì™„ë£Œ! (${w}x${h}, State:${readyState})`);
                
                // ìº”ë²„ìŠ¤ í¬ê¸° ë™ê¸°í™”
                canvas.width = w;
                canvas.height = h;
                
                document.getElementById('ui-controls').style.display = 'block';
                
                // ì•ˆì „í•˜ê²Œ ì—”ì§„ ì‹œì‘
                startOpenCV(w, h);
            } else {
                // ì•„ì§ ì¤€ë¹„ ì•ˆ ë¨. ë¡œê·¸ë¥¼ 1ì´ˆì— í•œ ë²ˆë§Œ ì°ìœ¼ë©° ëŒ€ê¸° (ë„ë°° ë°©ì§€)
                if (Math.random() < 0.05) log(`...ëŒ€ê¸° ì¤‘ (Size:${w}x${h}, State:${readyState})`);
                requestAnimationFrame(monitorVideoState);
            }
        }

        function startOpenCV(w, h) {
            log("ë©”ëª¨ë¦¬ í• ë‹¹ ì‹œì‘...");
            try {
                // ê¸°ì¡´ ê°ì²´ ì •ë¦¬
                if(cap) { try{ cap.delete(); } catch(e){} cap = null; }
                if(srcMat) srcMat.delete(); 
                if(grayMat) grayMat.delete();
                if(oldGrayMat) oldGrayMat.delete();
                if(p0) p0.delete(); 
                if(p1) p1.delete(); 

                cap = new cv.VideoCapture(video);
                srcMat = new cv.Mat(h, w, cv.CV_8UC4);
                grayMat = new cv.Mat(h, w, cv.CV_8UC1);
                oldGrayMat = new cv.Mat(h, w, cv.CV_8UC1);
                p0 = new cv.Mat(); 
                p1 = new cv.Mat(); 
                st = new cv.Mat(); 
                err = new cv.Mat();

                // í…ŒìŠ¤íŠ¸ ì½ê¸°
                cap.read(srcMat);
                
                cv.cvtColor(srcMat, oldGrayMat, cv.COLOR_RGBA2GRAY);
                
                // íŠ¹ì§•ì  ì´ˆê¸° ì¶”ì¶œ
                let none = new cv.Mat();
                cv.goodFeaturesToTrack(oldGrayMat, p0, 100, 0.3, 7, none, 7, false, 0.04);
                none.delete();

                log(`ğŸš€ ì—”ì§„ ê°€ë™ ì„±ê³µ! (ì´ˆê¸° íŠ¹ì§•ì : ${p0.rows}ê°œ)`);
                isCVRunning = true;
                processLoop();

            } catch (e) {
                log("âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: " + e);
                log("ì¬ì‹œë„ í•©ë‹ˆë‹¤...");
                setTimeout(() => startOpenCV(w, h), 1000);
            }
        }

        function processLoop() {
            if(!isCVRunning) return;

            try {
                // ë°©ì–´ ì½”ë“œ: ë¹„ë””ì˜¤ ìƒíƒœê°€ ë‚˜ë¹ ì§€ë©´ ì ì‹œ ì¤‘ë‹¨
                if (video.readyState < 3 || video.videoWidth === 0) {
                    // log("Frame Drop: Video not ready");
                    requestAnimationFrame(processLoop);
                    return;
                }

                // ìº¡ì²˜
                cap.read(srcMat);
                
                // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë³€í™˜
                cv.cvtColor(srcMat, grayMat, cv.COLOR_RGBA2GRAY);
                
                if(p0.rows > 0) {
                    // Optical Flow ê³„ì‚°
                    cv.calcOpticalFlowPyrLK(oldGrayMat, grayMat, p0, p1, st, err);
                    
                    finalFeatures = [];
                    let goodPoints = [];
                    
                    for(let i=0; i<p0.rows; i++) {
                        if(st.data[i] === 1) {
                            let nx = p1.data32F[i*2];
                            let ny = p1.data32F[i*2+1];
                            
                            // ê·¸ë¦¬ê¸°
                            cv.circle(srcMat, new cv.Point(nx, ny), 5, [0, 255, 0, 255], -1);
                            
                            finalFeatures.push({ u: nx/srcMat.cols, v: ny/srcMat.rows });
                            goodPoints.push(nx, ny);
                        }
                    }
                    
                    // í™”ë©´ ì¶œë ¥
                    cv.imshow('canvasOutput', srcMat);
                    
                    // ì  ê´€ë¦¬
                    if(goodPoints.length < 30) {
                        let none = new cv.Mat();
                        cv.goodFeaturesToTrack(grayMat, p0, 100, 0.3, 7, none, 7, false, 0.04);
                        none.delete();
                    } else { 
                        p1.copyTo(p0); 
                    }
                } else {
                    // ì  ì¬ì¶”ì¶œ
                    let none = new cv.Mat();
                    cv.goodFeaturesToTrack(grayMat, p0, 100, 0.3, 7, none, 7, false, 0.04);
                    none.delete();
                    cv.imshow('canvasOutput', srcMat); // ì  ì—†ì„ ë•Œë„ í™”ë©´ì€ ë³´ì—¬ì•¼ í•¨
                }
                
                grayMat.copyTo(oldGrayMat);

            } catch(e) {
                // log("Runtime Error (Skip): " + e);
            }
            
            requestAnimationFrame(processLoop);
        }

        // 3D ë³€í™˜ ì´ë²¤íŠ¸
        document.getElementById('btn-visualize').addEventListener('click', () => {
            log("3D ë³€í™˜ ëª¨ë“œ ì§„ì…");
            isCVRunning = false;
            
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());

            document.getElementById('canvasOutput').style.display = 'none';
            document.getElementById('ui-controls').style.display = 'none';
            document.getElementById('threejs-container').style.display = 'block';
            
            initThreeJS();
        });

        // Three.js Logic
        function initThreeJS() {
            const container = document.getElementById('threejs-container');
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);
            
            const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 5); camera.lookAt(0,0,0);
            
            const renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            
            const controls = new OrbitControls(camera, renderer.domElement);
            scene.add(new THREE.GridHelper(10, 20));
            scene.add(new THREE.AxesHelper(2));
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 10, 5); scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));

            if(finalFeatures.length > 0) {
                const geo = new THREE.SphereGeometry(0.1);
                const mat = new THREE.MeshBasicMaterial({color: 0x00ff00});
                const mesh = new THREE.InstancedMesh(geo, mat, finalFeatures.length);
                const dummy = new THREE.Object3D();
                const color = new THREE.Color();
                
                const sx = 5.0, sy = 5.0 * (window.innerHeight/window.innerWidth);
                
                finalFeatures.forEach((f, i) => {
                    const x = (f.u - 0.5) * sx;
                    const z = -(f.v - 0.5) * sy;
                    const y = (Math.random()-0.5) * 1.5;
                    dummy.position.set(x, y, z);
                    dummy.updateMatrix();
                    mesh.setMatrixAt(i, dummy.matrix);
                    color.setHSL(Math.random(), 1.0, 0.5);
                    mesh.setColorAt(i, color);
                });
                mesh.instanceMatrix.needsUpdate = true;
                mesh.instanceColor.needsUpdate = true;
                scene.add(mesh);
            }
            
            function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
            animate();
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
    </script>
</body>
</html>