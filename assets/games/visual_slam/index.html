<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Robust V-SLAM (Resolution Fix)</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: monospace; color: white; }
        
        #console-log {
            position: absolute; top: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.7); pointer-events: none; z-index: 999;
            padding: 10px; box-sizing: border-box; font-size: 12px; color: #ffff00;
            overflow-y: auto; white-space: pre-wrap;
        }

        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 800;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #btn-start {
            padding: 20px 40px; font-size: 20px; font-weight: bold; 
            background: #0088ff; color: white; border: none; border-radius: 10px; cursor: pointer;
        }
        #btn-start:disabled { background: #555; cursor: wait; }
        
        /* Ï∫îÎ≤ÑÏä§ ÏÇ¨Ïù¥Ï¶àÎäî CSSÎ°ú 100% Ï±ÑÏö∞Îêò, ÎπÑÏú®ÏùÄ JSÎ°ú Ï†úÏñ¥ */
        #video-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 500; 
            background: black; display: flex; justify-content: center; align-items: center;
        }
        video { display: none; }
        #canvasOutput { max-width: 100%; max-height: 100%; }

        #threejs-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 600; 
            display: none; background: #222;
        }

        #ui-controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 900; display: none;
        }
        #btn-visualize {
            padding: 15px 30px; font-size: 16px; font-weight: bold; 
            background: #ff4757; color: white; border: none; border-radius: 30px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/@techstark/opencv-js@4.9.0-release.3/dist/opencv.js" onload="onOpenCvLoaded()" onerror="onOpenCvError()" type="text/javascript"></script>
</head>
<body>
    <div id="console-log">System Initializing...<br>Downloading OpenCV Engine (CDN)...<br></div>

    <div id="start-overlay">
        <h2 style="margin-bottom: 20px;">V-SLAM Core</h2>
        <button id="btn-start" disabled>ÏóîÏßÑ Î°úÎî© Ï§ë...</button>
        <p style="color: #aaa; margin-top: 10px;" id="loading-msg">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.</p>
    </div>

    <div id="video-container">
        <video id="videoInput" playsinline webkit-playsinline></video>
        <canvas id="canvasOutput"></canvas>
    </div>

    <div id="ui-controls">
        <button id="btn-visualize">‚èπ STOP & 3D VIEW</button>
    </div>

    <div id="threejs-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        function log(msg) {
            const el = document.getElementById('console-log');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `[${time}] ${msg}<br>`;
            el.scrollTop = el.scrollHeight;
        }

        let video, canvas, ctx, cap;
        let srcMat, grayMat, oldGrayMat, p0, p1, st, err;
        let isCVRunning = false;
        let finalFeatures = [];
        let scene, camera, renderer, controls, pointCloud;

        const loadingTimer = setTimeout(() => {
            if(document.getElementById('btn-start').disabled) {
                log("‚ùå Î°úÎî© ÌÉÄÏûÑÏïÑÏõÉ. ÏÉàÎ°úÍ≥†Ïπ® Ìï¥Ï£ºÏÑ∏Ïöî.");
                document.getElementById('loading-msg').innerText = "ÎÑ§Ìä∏ÏõåÌÅ¨ ÏßÄÏó∞.";
                document.getElementById('loading-msg').style.color = "red";
            }
        }, 20000);

        window.onOpenCvError = function() {
            clearTimeout(loadingTimer);
            log("‚ùå OpenCV Îã§Ïö¥Î°úÎìú Ïã§Ìå®.");
        }

        window.onOpenCvLoaded = function() {
            clearTimeout(loadingTimer);
            log("‚úÖ OpenCV Î°úÎìú ÏôÑÎ£å.");
            
            // Îü∞ÌÉÄÏûÑ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞
            if (cv.getBuildInformation) {
                enableStartButton();
            } else {
                cv['onRuntimeInitialized'] = enableStartButton;
            }
        };

        function enableStartButton() {
            const btn = document.getElementById('btn-start');
            btn.innerText = "üì∑ Ïπ¥Î©îÎùº ÏãúÏûë";
            btn.disabled = false;
            btn.style.backgroundColor = "#2ed573";
            btn.onclick = startCameraPipeline;
            document.getElementById('loading-msg').innerText = "Ï§ÄÎπÑ ÏôÑÎ£å.";
        }

        async function startCameraPipeline() {
            document.getElementById('start-overlay').style.display = 'none'; 
            video = document.getElementById('videoInput');
            canvas = document.getElementById('canvasOutput');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });

                log("Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º ÌöçÎìù.");
                video.srcObject = stream;
                video.play();

                waitForVideoSize();

            } catch (err) {
                log("‚ùå Ïπ¥Î©îÎùº ÏóêÎü¨: " + err.message);
                alert("Ïπ¥Î©îÎùº Í∂åÌïúÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
            }
        }

        function waitForVideoSize() {
            const w = video.videoWidth;
            const h = video.videoHeight;

            if (w && h) {
                log(`üìè Í∞êÏßÄÎêú Ìï¥ÏÉÅÎèÑ: ${w}x${h}`);
                // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞Î•º ÎπÑÎîîÏò§ÏôÄ ÎèôÏùºÌïòÍ≤å ÎßûÏ∂§ (ÎπÑÏú® ÏôúÍ≥° Î∞©ÏßÄ)
                canvas.width = w;
                canvas.height = h;
                
                document.getElementById('ui-controls').style.display = 'block';
                // ‚òÖ Ïó¨Í∏∞ÏÑú w, hÎ•º Ï†ïÌôïÌïòÍ≤å ÎÑòÍπÄ
                startOpenCVProcessing(w, h);
            } else {
                setTimeout(waitForVideoSize, 100);
            }
        }

        function startOpenCVProcessing(width, height) {
            log(`Î©îÎ™®Î¶¨ Ìï†Îãπ Ï§ë... (W:${width}, H:${height})`);
            try {
                // Ïù¥Ï†Ñ Î©îÎ™®Î¶¨ Ï†ïÎ¶¨ (Ïû¨ÏãúÏûë Ïãú)
                if(srcMat) srcMat.delete();
                if(grayMat) grayMat.delete();
                if(oldGrayMat) oldGrayMat.delete();
                if(p0) p0.delete();
                if(p1) p1.delete();
                if(st) st.delete();
                if(err) err.delete();
                if(cap) delete cap; // JS Í∞ùÏ≤¥Îäî delete

                cap = new cv.VideoCapture(video);
                
                // ‚òÖ ÌïµÏã¨ ÏàòÏ†ï: ÏàúÏÑúÎ•º Ï†ïÌôïÌûà ÏßÄÏºúÏïº Ìï®
                // cv.Mat(rows, cols, type) -> (height, width, type)
                srcMat = new cv.Mat(height, width, cv.CV_8UC4);
                grayMat = new cv.Mat(height, width, cv.CV_8UC1);
                oldGrayMat = new cv.Mat(height, width, cv.CV_8UC1);
                
                p0 = new cv.Mat(); 
                p1 = new cv.Mat(); 
                st = new cv.Mat(); 
                err = new cv.Mat();

                // Ï≤´ ÌîÑÎ†àÏûÑ ÏùΩÍ∏∞
                cap.read(srcMat);
                
                // ÏÇ¨Ïù¥Ï¶àÍ∞Ä Ïïà ÎßûÏúºÎ©¥ Ï¶âÏãú Ï§ëÎã® (Bad size Î∞©ÏßÄ)
                if (srcMat.cols !== width || srcMat.rows !== height) {
                    log(`‚ö†Ô∏è ÌÅ¨Í∏∞ Î∂àÏùºÏπò! Mat:${srcMat.cols}x${srcMat.rows} vs Video:${width}x${height}`);
                    throw new Error("Dimension Mismatch");
                }

                cv.cvtColor(srcMat, oldGrayMat, cv.COLOR_RGBA2GRAY);

                // ÌäπÏßïÏ†ê Ï∂îÏ∂ú
                let none = new cv.Mat();
                // ÌååÎùºÎØ∏ÌÑ∞: (Ïù¥ÎØ∏ÏßÄ, Í≤∞Í≥ºÏ†ê, Ï†êÍ∞úÏàò, ÌÄÑÎ¶¨Ìã∞, ÏµúÏÜåÍ±∞Î¶¨)
                cv.goodFeaturesToTrack(oldGrayMat, p0, 150, 0.3, 7, none, 7, false, 0.04);
                none.delete();

                log(`üöÄ ÏóîÏßÑ Í∞ÄÎèô ÏÑ±Í≥µ! Ï¥àÍ∏∞ ÌäπÏßïÏ†ê: ${p0.rows}Í∞ú`);
                isCVRunning = true;
                requestAnimationFrame(processVideoFrame);

            } catch (e) {
                log("‚ùå Ï¥àÍ∏∞Ìôî ÏóêÎü¨ (ÏÉÅÏÑ∏): " + e);
                // ÏóêÎü¨ Î∞úÏÉù Ïãú 1Ï¥à Îí§ Ïû¨ÏãúÎèÑ
                setTimeout(() => startOpenCVProcessing(width, height), 1000);
            }
        }

        function processVideoFrame() {
            if (!isCVRunning) return;

            try {
                cap.read(srcMat);
                
                // Îü∞ÌÉÄÏûÑ ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨
                if (srcMat.cols !== video.videoWidth || srcMat.rows !== video.videoHeight) {
                    log("‚ö†Ô∏è Ìï¥ÏÉÅÎèÑ Î≥ÄÍ≤Ω Í∞êÏßÄÎê®. Ïû¨ÏÑ§Ï†ï ÌïÑÏöî.");
                    isCVRunning = false;
                    // Ìï¥ÏÉÅÎèÑ Îã§Ïãú ÏùΩÏñ¥ÏÑú Ïû¨ÏãúÏûë
                    waitForVideoSize(); 
                    return;
                }

                cv.cvtColor(srcMat, grayMat, cv.COLOR_RGBA2GRAY);

                if (p0.rows > 0) {
                    // Optical Flow Í≥ÑÏÇ∞
                    cv.calcOpticalFlowPyrLK(oldGrayMat, grayMat, p0, p1, st, err);

                    let goodPoints = [];
                    finalFeatures = []; 

                    for (let i = 0; i < p0.rows; i++) {
                        if (st.data[i] === 1) {
                            let newX = p1.data32F[i * 2];
                            let newY = p1.data32F[i * 2 + 1];

                            // Ï†ê Í∑∏Î¶¨Í∏∞
                            cv.circle(srcMat, new cv.Point(newX, newY), 5, [0, 255, 0, 255], -1);
                            
                            // 3DÏö© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                            finalFeatures.push({
                                u: newX / srcMat.cols,
                                v: newY / srcMat.rows
                            });
                            
                            goodPoints.push(newX, newY);
                        }
                    }

                    cv.imshow('canvasOutput', srcMat);

                    // Ï†êÏù¥ ÎÑàÎ¨¥ Ï†ÅÏúºÎ©¥ Îã§Ïãú Ï∞æÍ∏∞
                    if (goodPoints.length < 30) {
                        let none = new cv.Mat();
                        cv.goodFeaturesToTrack(grayMat, p0, 150, 0.3, 7, none, 7, false, 0.04);
                        none.delete();
                    } else {
                        // ÌòÑÏû¨ Ï†êÏùÑ Îã§Ïùå ÌîÑÎ†àÏûÑÏùò Í≥ºÍ±∞ Ï†êÏúºÎ°ú Î≥µÏÇ¨
                        p1.copyTo(p0);
                    }
                } else {
                    // Ï†êÏùÑ Îã§ ÏûÉÏñ¥Î≤ÑÎ†∏ÏúºÎ©¥ Ïû¨Ï∂îÏ∂ú
                     let none = new cv.Mat();
                     cv.goodFeaturesToTrack(grayMat, p0, 150, 0.3, 7, none, 7, false, 0.04);
                     none.delete();
                }
                
                grayMat.copyTo(oldGrayMat);
                requestAnimationFrame(processVideoFrame);

            } catch (e) {
                log("Îü∞ÌÉÄÏûÑ ÏóêÎü¨: " + e);
                isCVRunning = false;
            }
        }

        document.getElementById('btn-visualize').addEventListener('click', () => {
            log("üõë 3D Î≥ÄÌôò ÏãúÏûë.");
            isCVRunning = false;
            
            // ÎπÑÎîîÏò§ Ï†ïÏßÄ Î∞è Ïà®ÍπÄ
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('video-container').style.display = 'none';
            document.getElementById('ui-controls').style.display = 'none';
            
            // 3D Î≥¥Ïù¥Í∏∞
            document.getElementById('threejs-container').style.display = 'block';
            initThreeJS();
        });

        // --- 3D ÏãúÍ∞ÅÌôî ÌååÌä∏ ---
        function initThreeJS() {
            const container = document.getElementById('threejs-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 5);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            scene.add(new THREE.GridHelper(10, 20, 0x888888, 0x444444));
            scene.add(new THREE.AxesHelper(2));
            
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 10, 5);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));

            createPointCloud();
            animate3D();
        }

        function createPointCloud() {
            if (finalFeatures.length === 0) {
                log("‚ö†Ô∏è Î≥ÄÌôòÌï† ÌäπÏßïÏ†êÏù¥ ÏóÜÏäµÎãàÎã§.");
                return;
            }

            const geometry = new THREE.SphereGeometry(0.1, 8, 8);
            const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
            pointCloud = new THREE.InstancedMesh(geometry, material, finalFeatures.length);

            const dummy = new THREE.Object3D();
            const color = new THREE.Color();
            
            // ÏÑ∏Î°ú Î™®Îìú ÎåÄÏùë Ïä§ÏºÄÏùº
            const SCALE_X = 5.0; 
            const SCALE_Y = SCALE_X * (window.innerHeight / window.innerWidth); 

            for(let i=0; i<finalFeatures.length; i++) {
                const f = finalFeatures[i];
                const x = (f.u - 0.5) * SCALE_X;
                const y = -(f.v - 0.5) * SCALE_Y;
                const z = (Math.random() - 0.5) * 1.5;

                dummy.position.set(x, z, y); 
                dummy.updateMatrix();
                pointCloud.setMatrixAt(i, dummy.matrix);

                color.setHSL(Math.random(), 1.0, 0.5);
                pointCloud.setColorAt(i, color);
            }

            pointCloud.instanceMatrix.needsUpdate = true;
            pointCloud.instanceColor.needsUpdate = true;
            scene.add(pointCloud);
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>