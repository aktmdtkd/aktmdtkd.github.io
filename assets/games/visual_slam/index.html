<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Robust V-SLAM Visualizer</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: monospace; color: white; }
        
        /* 1. ìƒíƒœ ë¡œê·¸ì°½ (ê°€ì¥ ìœ„ì— í‘œì‹œ) */
        #console-log {
            position: absolute; top: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.7); pointer-events: none; z-index: 999;
            padding: 10px; box-sizing: border-box; font-size: 12px; color: #ffff00;
            overflow-y: auto; white-space: pre-wrap;
        }

        /* 2. ì‹œì‘ ë²„íŠ¼ (ì¤‘ì•™) */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 800;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #btn-start {
            padding: 20px 40px; font-size: 20px; font-weight: bold; 
            background: #0088ff; color: white; border: none; border-radius: 10px; cursor: pointer;
        }
        #btn-start:disabled { background: #555; cursor: wait; }

        /* 3. 2D ë¹„ë””ì˜¤ ì˜ì—­ */
        #video-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 500; 
            background: black;
        }
        video { display: none; } /* ë¹„ë””ì˜¤ëŠ” ìˆ¨ê¸°ê³  ìº”ë²„ìŠ¤ë§Œ ë³´ì—¬ì¤Œ */
        #canvasOutput { width: 100%; height: 100%; object-fit: cover; }

        /* 4. 3D ë·°ì–´ ì˜ì—­ (ì²˜ìŒì—” ìˆ¨ê¹€) */
        #threejs-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 600; 
            display: none; background: #222;
        }

        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
        #ui-controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 900; display: none; /* ì¹´ë©”ë¼ ì¼œì§€ë©´ ë³´ì„ */
        }
        #btn-visualize {
            padding: 15px 30px; font-size: 16px; font-weight: bold; 
            background: #ff4757; color: white; border: none; border-radius: 30px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvLoaded()" type="text/javascript"></script>
</head>
<body>
    <div id="console-log">System Initializing...<br></div>

    <div id="start-overlay">
        <h2 style="margin-bottom: 20px;">V-SLAM Core</h2>
        <button id="btn-start" disabled>OpenCV ë¡œë”© ì¤‘...</button>
        <p style="color: #aaa; margin-top: 10px;">(íŒŒì¼ì´ ì»¤ì„œ 5~10ì´ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)</p>
    </div>

    <div id="video-container">
        <video id="videoInput" playsinline webkit-playsinline></video>
        <canvas id="canvasOutput"></canvas>
    </div>

    <div id="ui-controls">
        <button id="btn-visualize">â¹ STOP & 3D VIEW</button>
    </div>

    <div id="threejs-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // === ë¡œê¹… ìœ í‹¸ë¦¬í‹° ===
        function log(msg) {
            const el = document.getElementById('console-log');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `[${time}] ${msg}<br>`;
            el.scrollTop = el.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
            console.log(msg);
        }

        // ì „ì—­ ë³€ìˆ˜
        let video, canvas, ctx, cap;
        let srcMat, grayMat, oldGrayMat, p0, p1, st, err;
        let isCVRunning = false;
        let finalFeatures = [];

        // Three.js ë³€ìˆ˜
        let scene, camera, renderer, controls, pointCloud;

        // 1. OpenCV ë¡œë”© ì™„ë£Œ ì²´í¬
        window.onOpenCvLoaded = function() {
            log("âœ… OpenCV ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!");
            log("ì´ì œ 'ì¹´ë©”ë¼ ì‹œì‘' ë²„íŠ¼ì„ ëˆ„ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            
            const btn = document.getElementById('btn-start');
            btn.innerText = "ğŸ“· ì¹´ë©”ë¼ ì‹œì‘ (Start Camera)";
            btn.disabled = false;
            btn.style.backgroundColor = "#2ed573";
            
            btn.onclick = startCameraPipeline;
        };

        // 2. ì¹´ë©”ë¼ ì‹œì‘ íŒŒì´í”„ë¼ì¸
        async function startCameraPipeline() {
            log("ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...");
            document.getElementById('start-overlay').style.display = 'none'; // ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€

            video = document.getElementById('videoInput');
            canvas = document.getElementById('canvasOutput');
            
            // ìº”ë²„ìŠ¤ í¬ê¸° ì„ì‹œ ì„¤ì •
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                });

                log("ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“ ì„±ê³µ.");
                video.srcObject = stream;
                video.play();

                video.onloadedmetadata = () => {
                    log(`ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œë¨: ${video.videoWidth}x${video.videoHeight}`);
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    document.getElementById('ui-controls').style.display = 'block';
                    startOpenCVProcessing();
                };

            } catch (err) {
                log("âŒ ì¹´ë©”ë¼ ì—ëŸ¬: " + err.message);
                alert("ì¹´ë©”ë¼ë¥¼ ì¼¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. HTTPSì¸ì§€ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        // 3. OpenCV ì²˜ë¦¬ ë£¨í”„ (Optical Flow)
        function startOpenCVProcessing() {
            log("OpenCV ë©”ëª¨ë¦¬ í• ë‹¹ ì¤‘...");
            try {
                cap = new cv.VideoCapture(video);
                srcMat = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
                grayMat = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
                oldGrayMat = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
                
                p0 = new cv.Mat();
                p1 = new cv.Mat();
                st = new cv.Mat();
                err = new cv.Mat();

                // ì²« í”„ë ˆì„ ì½ê¸°
                cap.read(srcMat);
                cv.cvtColor(srcMat, oldGrayMat, cv.COLOR_RGBA2GRAY);

                // íŠ¹ì§•ì  ì¶”ì¶œ
                let none = new cv.Mat();
                cv.goodFeaturesToTrack(oldGrayMat, p0, 200, 0.3, 7, none, 7, false, 0.04);
                none.delete();

                log("ğŸš€ ì¶”ì  ì—”ì§„ ê°€ë™ ì‹œì‘!");
                isCVRunning = true;
                requestAnimationFrame(processVideoFrame);

            } catch (e) {
                log("âŒ OpenCV ì´ˆê¸°í™” ì‹¤íŒ¨: " + e);
            }
        }

        function processVideoFrame() {
            if (!isCVRunning) return;

            try {
                // ë¹„ë””ì˜¤ ì½ê¸°
                cap.read(srcMat);
                cv.cvtColor(srcMat, grayMat, cv.COLOR_RGBA2GRAY);

                // íŠ¹ì§•ì  ì¶”ì 
                if (p0.rows > 0) {
                    cv.calcOpticalFlowPyrLK(oldGrayMat, grayMat, p0, p1, st, err);

                    // ê·¸ë¦¬ê¸° ë° ë°ì´í„° ì €ì¥
                    let goodPoints = [];
                    finalFeatures = []; // í˜„ì¬ í”„ë ˆì„ ë°ì´í„° ì´ˆê¸°í™”

                    for (let i = 0; i < p0.rows; i++) {
                        if (st.data[i] === 1) {
                            let newX = p1.data32F[i * 2];
                            let newY = p1.data32F[i * 2 + 1];

                            // ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° (OpenCV í•¨ìˆ˜)
                            cv.circle(srcMat, new cv.Point(newX, newY), 5, [0, 255, 0, 255], -1);
                            
                            // ë°ì´í„° ì €ì¥ (ë‚˜ì¤‘ì— 3Dë¡œ ë³€í™˜ìš©)
                            finalFeatures.push({
                                u: (newX / canvas.width) - 0.5,
                                v: (newY / canvas.height) - 0.5
                            });
                            
                            goodPoints.push(newX, newY);
                        }
                    }

                    // í™”ë©´ ì—…ë°ì´íŠ¸
                    cv.imshow('canvasOutput', srcMat);

                    // ì ì´ ë„ˆë¬´ ì ìœ¼ë©´ ì¬ì¶”ì¶œ
                    if (goodPoints.length < 30) {
                        let none = new cv.Mat();
                        cv.goodFeaturesToTrack(grayMat, p0, 200, 0.3, 7, none, 7, false, 0.04);
                        none.delete();
                    } else {
                        p1.copyTo(p0);
                    }
                }
                
                // í˜„ì¬ -> ê³¼ê±° í”„ë ˆì„ ì €ì¥
                grayMat.copyTo(oldGrayMat);
                requestAnimationFrame(processVideoFrame);

            } catch (e) {
                log("ì²˜ë¦¬ ì¤‘ ì—ëŸ¬: " + e);
                isCVRunning = false;
            }
        }

        // 4. ëª¨ë“œ ì „í™˜ (2D -> 3D)
        document.getElementById('btn-visualize').addEventListener('click', () => {
            log("ğŸ›‘ ì¶”ì  ì¤‘ë‹¨. 3D ì‹œê°í™” ëª¨ë“œ ì „í™˜.");
            isCVRunning = false;

            // ì¹´ë©”ë¼ ë¦¬ì†ŒìŠ¤ í•´ì œ
            if(video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            // í™”ë©´ ì „í™˜
            document.getElementById('video-container').style.display = 'none';
            document.getElementById('ui-controls').style.display = 'none';
            document.getElementById('threejs-container').style.display = 'block';

            initThreeJS();
        });

        // 5. Three.js 3D ë·°ì–´
        function initThreeJS() {
            log("Three.js ì›”ë“œ ìƒì„± ì¤‘...");
            const container = document.getElementById('threejs-container');

            // ì”¬ ì„¤ì •
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);

            // ì¹´ë©”ë¼ ì„¤ì • (ë²„ë“œì•„ì´ë·°)
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 5); // ìœ„ì—ì„œ ì•„ë˜ë¡œ
            camera.lookAt(0, 0, 0);

            // ë Œë”ëŸ¬
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // ì»¨íŠ¸ë¡¤
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // ê²©ì ë° ì¶•
            const gridHelper = new THREE.GridHelper(10, 20, 0x888888, 0x444444);
            scene.add(gridHelper);
            const axesHelper = new THREE.AxesHelper(2);
            scene.add(axesHelper);

            // ì¡°ëª…
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 10, 5);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));

            // ì êµ° ìƒì„±
            createPointCloud();
            
            // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            animate3D();
        }

        function createPointCloud() {
            if (finalFeatures.length === 0) {
                log("âš ï¸ ì €ì¥ëœ íŠ¹ì§•ì ì´ ì—†ìŠµë‹ˆë‹¤. (ì¶”ì ì´ ì•ˆ ëê±°ë‚˜ ë„ˆë¬´ ì§§ì•˜ìŒ)");
                return;
            }

            log(`ğŸ“Š ìˆ˜ì§‘ëœ íŠ¹ì§•ì  ${finalFeatures.length}ê°œë¥¼ 3Dë¡œ ë³€í™˜í•©ë‹ˆë‹¤.`);

            const geometry = new THREE.SphereGeometry(0.1, 8, 8);
            const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
            pointCloud = new THREE.InstancedMesh(geometry, material, finalFeatures.length);

            const dummy = new THREE.Object3D();
            const color = new THREE.Color();
            
            const FAKE_DEPTH = 4.0; // 4ë¯¸í„° ì• ê°€ìƒ í‰ë©´
            const SCALE = 5.0; // í¼ì§ ì •ë„

            for(let i=0; i<finalFeatures.length; i++) {
                const f = finalFeatures[i];
                
                // 2D -> 3D íˆ¬ì˜
                const x = f.u * SCALE;
                const y = -f.v * SCALE; // Yì¶• ë°˜ì „
                const z = (Math.random() - 0.5) * 1.0; // ì•½ê°„ì˜ ì…ì²´ê°ì„ ìœ„í•´ Zì¶• ë…¸ì´ì¦ˆ ì¶”ê°€

                dummy.position.set(x, z, y); // ë²„ë“œì•„ì´ë·°ë‹ˆê¹Œ Yê°€ ë†’ì´(Z)ê°€ ë¨
                dummy.updateMatrix();
                pointCloud.setMatrixAt(i, dummy.matrix);

                // ìƒ‰ìƒ ë‹¤ì–‘í™”
                color.setHSL(Math.random(), 1.0, 0.5);
                pointCloud.setColorAt(i, color);
            }

            pointCloud.instanceMatrix.needsUpdate = true;
            pointCloud.instanceColor.needsUpdate = true;
            scene.add(pointCloud);
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>