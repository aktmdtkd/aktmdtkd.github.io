<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebXR SLAM & 3D Viewer</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #info {
            position: absolute; top: 10px; width: 100%; text-align: center; z-index: 100;
            color: #00ff00; font-weight: bold; text-shadow: 1px 1px 2px black; pointer-events: none;
        }
        #viewer-hint {
            display: none; position: absolute; bottom: 30px; width: 100%; text-align: center;
            color: white; background: rgba(0,0,0,0.5); padding: 10px;
        }
    </style>
</head>
<body>
    <div id="info">START ARì„ ëˆŒëŸ¬ ê³µê°„ì„ ìŠ¤ìº”í•˜ì„¸ìš”.<br>ì¢…ë£Œí•˜ë©´ 3D ì§€ë„ê°€ ë©ë‹ˆë‹¤.</div>
    <div id="viewer-hint">ğŸ‘† í„°ì¹˜í•˜ì—¬ íšŒì „ / âœŒï¸ ë‘ ì†ê°€ë½ìœ¼ë¡œ í™•ëŒ€</div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
        import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';
        // 3D ë·°ì–´ ì»¨íŠ¸ë¡¤ì„ ìœ„í•´ OrbitControls ì¶”ê°€
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        let container;
        let camera, scene, renderer;
        let controller;
        let controls; // ë·°ì–´ ëª¨ë“œìš© ì»¨íŠ¸ë¡¤ëŸ¬

        let hitTestSource = null;
        let hitTestSourceRequested = false;

        const MAX_POINTS = 3000; // ì  ê°œìˆ˜ ëŠ˜ë¦¼
        let mesh; 
        let count = 0;
        const dummy = new THREE.Object3D();

        let isARMode = false; // í˜„ì¬ AR ëª¨ë“œì¸ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

        init();
        animate();

        function init() {
            container = document.createElement('div');
            document.body.appendChild(container);

            scene = new THREE.Scene();

            // ì´ˆê¸° ì¹´ë©”ë¼ëŠ” ARìš© ì„¸íŒ… (í•˜ì§€ë§Œ ë·°ì–´ ëª¨ë“œì—ì„œë„ ì“°ì„)
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true; 
            container.appendChild(renderer.domElement);

            // AR ë²„íŠ¼ ìƒì„±
            const button = ARButton.createButton(renderer, {
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'], 
                domOverlay: { root: document.body }
            });
            document.body.appendChild(button);

            // â˜… ì¤‘ìš”: AR ì„¸ì…˜ ì‹œì‘/ì¢…ë£Œ ê°ì§€
            // ARButtonì€ í´ë¦­ ì‹œ ì„¸ì…˜ì„ ë§Œë“œëŠ”ë°, ìš°ë¦¬ëŠ” ë Œë”ëŸ¬ì˜ ì´ë²¤íŠ¸ë¥¼ í†µí•´ ìƒíƒœë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
            renderer.xr.addEventListener('sessionstart', onSessionStart);
            renderer.xr.addEventListener('sessionend', onSessionEnd);

            // ì êµ°(Point Cloud) ìƒì„±
            const geometry = new THREE.IcosahedronGeometry(0.015, 1); // ì  í¬ê¸° ì•½ê°„ í‚¤ì›€
            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 }); 
            mesh = new THREE.InstancedMesh(geometry, material, MAX_POINTS);
            mesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
            scene.add(mesh);

            window.addEventListener('resize', onWindowResize);
        }

        // AR ì‹œì‘ë  ë•Œ í˜¸ì¶œ
        function onSessionStart() {
            isARMode = true;
            document.getElementById('info').innerText = "ë°”ë‹¥ê³¼ ë²½ì„ ë¹„ì¶”ë©° ì´ë™í•˜ì„¸ìš”.";
            document.getElementById('viewer-hint').style.display = 'none';
            scene.background = null; // ë°°ê²½ íˆ¬ëª… (ì¹´ë©”ë¼ ë³´ì„)
        }

        // â˜… AR ì¢…ë£Œë  ë•Œ í˜¸ì¶œ (ë·°ì–´ ëª¨ë“œë¡œ ì „í™˜)
        function onSessionEnd() {
            isARMode = false;
            document.getElementById('info').innerText = "3D Map Viewer Mode";
            document.getElementById('viewer-hint').style.display = 'block';

            // 1. ë°°ê²½ì„ ê²€ì€ìƒ‰ìœ¼ë¡œ ë³€ê²½ (ë” ì´ìƒ ì¹´ë©”ë¼ ì•ˆ ë³´ì„)
            scene.background = new THREE.Color(0x222222);

            // 2. ì¹´ë©”ë¼ ìœ„ì¹˜ ì¬ì„¤ì • (ì „ì²´ ë§µì„ ë³¼ ìˆ˜ ìˆê²Œ ë’¤ë¡œ ëºŒ)
            // AR ì¢Œí‘œê³„ì—ì„œ 0,0,0ì€ 'ì•±ì„ ì¼  ìœ„ì¹˜'ì…ë‹ˆë‹¤.
            camera.position.set(0, 1.5, 2); 
            camera.lookAt(0, 0, 0);

            // 3. OrbitControls í™œì„±í™” (í„°ì¹˜ë¡œ ëŒë ¤ë³´ê¸°)
            if (!controls) {
                controls = new OrbitControls(camera, renderer.domElement);
                controls.target.set(0, 0, -1); // ì‹œì„ ì„ ì•½ê°„ ì•ìª½ìœ¼ë¡œ
                controls.update();
            }
            
            // 4. WebXR ë„ê¸° (ì¼ë°˜ ë Œë”ë§ ë£¨í”„ë¡œ ëŒì•„ê°€ê¸° ìœ„í•´)
            renderer.xr.enabled = false;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            renderer.setAnimationLoop(render);
        }

        let lastScanTime = 0;

        function render(timestamp, frame) {
            // === AR ëª¨ë“œì¼ ë•Œ (ë°ì´í„° ìˆ˜ì§‘) ===
            if (isARMode && frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then((refSpace) => {
                        session.requestHitTestSource({ space: refSpace }).then((source) => {
                            hitTestSource = source;
                        });
                    });
                    session.addEventListener('end', () => {
                        hitTestSourceRequested = false;
                        hitTestSource = null;
                    });
                    hitTestSourceRequested = true;
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    // ìŠ¤ìº” ì†ë„ ì¡°ì ˆ (30ms ë§ˆë‹¤)
                    if (hitTestResults.length > 0 && count < MAX_POINTS && timestamp - lastScanTime > 30) {
                        const hit = hitTestResults[0];
                        const pose = hit.getPose(referenceSpace);

                        dummy.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
                        dummy.updateMatrix();

                        mesh.setMatrixAt(count++, dummy.matrix);
                        mesh.instanceMatrix.needsUpdate = true; 
                        lastScanTime = timestamp;
                    }
                }
                renderer.render(scene, camera);
            } 
            
            // === ë·°ì–´ ëª¨ë“œì¼ ë•Œ (ë°ì´í„° í™•ì¸) ===
            else if (!isARMode) {
                // OrbitControls ì—…ë°ì´íŠ¸ í•„ìš”
                if (controls) controls.update();
                renderer.render(scene, camera);
            }
        }
    </script>
</body>
</html>